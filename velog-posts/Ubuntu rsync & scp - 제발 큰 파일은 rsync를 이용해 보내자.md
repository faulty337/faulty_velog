### 대충 그럴싸한 서론

DB를 백업을 하는 일이 있었는데 이를 다른 DB로 이관하는 작업을 해야 했었다. 환경은 ubuntu 환경에서 docker container로 떠있었으며, DB가 Cassandra이기 때문에 백업 도구를 사용하기 힘들었다.

때문에 하드 백업을 통해 전체 파일을 복사하여 복원 테스트를 진행해봤고 docker compose에서 volume위치만 맞춰주면 되기에 진행했으나 docker로 띄워져 있는 동안 백업한 파일은 복원이 되지 않았다.

즉, docker를 down시키고 백업을 진행해야 하는데 용량이 매우 크기 때문에 서비스 중단시간이 매우 길어지는 상황이 예상되었다.

여기서 `rsync`를 통해서 중단시간을 최소화 시켰는데 사용법과 해당 부분을 정리해보았다.

### Ubuntu 파일 전송 명령어

기본적으로 `scp`를 이용해 파일을 간단히 전송할 수 있다. 외부에서 내부는 물론, 내부에서 내부, 외부에서 외부까지도 가능하다. 단 외부에 전송에 있어서 접속 보안(password or keyfile)은 처리가 되어 있어야 한다. 이외에도 `rsync`, `sftp`, `ftp` 등이 있으며 이번엔 `scp`와 `rsync`에 대해서만 다뤄보고자 하낟.

### `scp`

Secure Copy Protocol의 약자로 SSH를 기반으로 안전하게 파일을 전송하는 기본적인 명령어이다.

#### SSH 암호화를 통해 파일을 안전하게 전송한다.

기본적으로 암호화를 통해 전송되기 때문에 안전하게 전송될 수 있다.

#### `scp`는 전체 파일 전송을 목적으로 둔다.

이 말은 즉, 대상에 같은 이름의 파일이 있더라도 무조건 덮어씌운다는 말이다. 위에 서론에 있었던 환경의 경우, docker container를 내리고 전송을 시작하며 전체 덮어쓰기에 느릴 수밖에 없게 된다.

#### 간단 사용법

기본적으로 `scp [옵션] [소스경로] [목적지 경로]` 로 구성된다.

```bash

#로컬 파일을 외부로
scp /path/to/local/file user@remote_host:/path/to/remote/

#외부 파일을 로컬로
scp user@remote_host:/path/to/remote/file /path/to/local/
```

`-r`: 디렉토리를 재귀적으로 복사 `-P`: 원격 서버의 SSH 포트를 지정 `-i`: SSH 키 파일을 지정 `-q`: 조용 모드로 실행하여 `-C`: 압축하여 전송

### rsync

Remote Sync의 약자로 파일을 '동기화'하거나 백업할 때 사용되는 유틸리티이다.

#### 동기화 가능

`rsync`는 원본과 대상 디렉토리를 정확히 일치시키는 동기화 작업을 쉽게 할 수 있다.

#### 변경된 부분만 전송

이부분이 핵심인데 전체파일을 전송하는 것이 아닌 변경된 부분만 전송하게 된다. 이 말은 V1 파일을 전송하고 변경이후에 V2를 전송하면 V1에서 변경부분만 전송하여 속도와 네트워크 사용량을 크게 줄일 수 있다!

*** ** * ** ***

위 서론 예시를 보면

1. docker container가 띄워져 있는 상태를 V1으로 생각한다.
2. 미리 전송하여 대용량을 전송하지만, docker는 안죽어있게 된다.
3. 전부 전송 완료시 docker container를 내린다.
4. 변경된부분 즉, V2 (복원이 안되는 파일 -\> 복원이 되는 파일의 부분 전송)을 전송한다.
5. docker container를 다시 올린다.

물론 host를 바꾸거나 하는 작업은 빠졌지만, DB용량으로 인한 서비스 중단 시간을 최소화 할 수 있었다.

*** ** * ** ***

#### 간단 사용법

기본적으로 scp와 비슷한 형식이며 `rsync [옵션] [소스 경로] [목적지 경로]` 로 구성된다.

```bash
# 로컬 파일을 원격 서버로 전송
rsync -av /path/to/local/file user@remote_host:/path/to/remote/

# 원격 서버의 파일을 로컬로 전송
rsync -av user@remote_host:/path/to/remote/file /path/to/local/
```

`-a`: 아카이브 모드로, 파일의 소유권, 권한, 시간 정보를 유지하면서 디렉토리 구조를 복사 `-v`: 전송 진행 상태를 표시 `-z`: 데이터 전송 시 압축 적용 `-r`: 디렉토리를 재귀적으로 복사 `--progress`: 전송 중인 파일의 진행 상황 표시 `--delete`: 대상에서 원본에 없는 파일을 삭제하여 원본과 완전 일치

### 대충 그럴싸한 마무리

둘다 기능적으로는 **'무언가를 전송한다'** 는 같다. 하지만 **'어떻게 전송하냐'**는 다르다. 이 두차이를 이해하고 적절히 써야하는데,
> **그냥 전송할 때 rsync쓰면 되는거 아냐?** → `scp`의 경우 설정이 매우 간단하며, `rsync`와 같이 부분만 전송하기 위한 계산이 안들어간다. 때문에 빠르고 간편한 전송에서는 `scp`를 쓰는 것이 좋다. ~~사실 그냥 `rsync`만 익히고 쓰는것도 나쁘지 않을거 같다.~~

어느정도 되면 도구의 결과가 아닌 과정이 필요할 때도 있는 듯 하다.
